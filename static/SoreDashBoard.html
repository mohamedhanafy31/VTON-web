<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Dashboard - Garment Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css">
    
    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
      .header-logo {
        display: block;
        margin: 0 auto 20px auto;
        max-height: 100px;
        max-width: 200px;
        width: auto;
        object-fit: contain;
      }
      .login-container {
        max-width: 400px;
        margin: 50px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
      }
      .login-container h2 {
        margin-bottom: 20px;
        font-size: 24px;
        color: #333;
      }
      .login-container input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
      }
      .login-container button {
        width: 100%;
        padding: 10px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
      }
      .login-container button:hover {
        background: #0056b3;
      }
      .error-message {
        color: #ff4444;
        margin-top: 10px;
        display: none;
      }
      .container {
        display: none;
      }
      .logo-container {
        width: 150px;
        height: 150px;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        overflow: hidden;
        background-color: #f8f8f8;
        border: 1px solid #eee;
      }
      .logo-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      /* Navigation Styles */
      .nav-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #ccc;
      }
      .nav-tab {
        padding: 10px 20px;
        margin: 0 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }
      .nav-tab:hover {
        color: #007bff;
      }
      .nav-tab.active {
        color: #007bff;
        border-bottom: 3px solid #007bff;
      }
      /* Orders Page Styles */
      .orders-container {
        display: none;
        padding: 20px;
      }
      .order-item {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        font-size: 16px;
        color: #333;
      }
      .order-item:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
    </style>
</head>
<body>
    <div id="notificationBar" style="display: none; position: fixed; top: 0; left: 0; right: 0; padding: 10px; text-align: center; z-index: 1000; font-weight: bold;"></div>

    <div class="login-container" id="loginContainer">
        <div class="logo-container">
            <img src="MetaVrLogo.jpg" alt="MetaVR Logo" class="header-logo">
        </div>
        <h2>Store Login</h2>
        <input type="email" id="emailInput" placeholder="Email" required>
        <input type="password" id="passwordInput" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <div class="error-message" id="errorMessage"></div>
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="debugSession()" style="background: #555; padding: 5px 10px; border: none; color: white; border-radius: 4px; font-size: 12px;">Debug Session</button>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <div class="logo-container">
            <img src="MetaVrLogo.jpg" alt="MetaVR Logo" class="header-logo" id="storeLogo">
        </div>
        <h1 id="storeHeading">Garment Image Management</h1>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('garments')">Garments</div>
            <div class="nav-tab" onclick="switchTab('orders')">Orders</div>
        </div>

        <!-- Garments Page -->
        <div id="garmentsContainer">
            <div class="upload-container">
                <input type="file" id="imageInput" accept="image/*" multiple>
                <select id="colorSelect">
                    <option value="" disabled selected>Select Color</option>
                    <option value="Red">Red</option>
                    <option value="Blue">Blue</option>
                    <option value="Green">Green</option>
                    <option value="Black">Black</option>
                    <option value="White">White</option>
                </select>
                <select id="garmentTypeSelect">
                    <option value="" disabled selected>Select Garment Type</option>
                    <option value="Shirt">Shirt</option>
                    <option value="T-Shirt">T-Shirt</option>
                    <option value="Dress">Dress</option>
                    <option value="Pants">Pants</option>
                    <option value="Jacket">Jacket</option>
                </select>
                <input type="text" id="garmentNameInput" placeholder="Garment Name (optional)" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px;">
                <div class="name-info" style="font-size: 0.8rem; margin-bottom: 10px; color: #666;">
                    <i class="fas fa-info-circle"></i> If no name is provided, it will be generated from color and type
                </div>
                <button id="uploadButton" onclick="uploadImages()">Upload</button>
                <div class="remaining-counter" id="remainingCounter">Remaining: 6/6</div>
            </div>
            <h2>Uploaded Garments</h2>
            <div class="spinner" id="spinner"></div>
            <div class="image-gallery" id="imageGallery"></div>
        </div>

        <!-- Orders Page -->
        <div id="ordersContainer" class="orders-container">
            <h2>Customer Orders</h2>
            <div class="spinner" id="ordersSpinner"></div>
            <div id="ordersList"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1L2ZtAGllfUEyE2phFjQkELGTFCFyDrw",
            authDomain: "metavrai-96ea0.firebaseapp.com",
            projectId: "metavrai-96ea0",
            storageBucket: "metavrai-96ea0.appspot.com",
            messagingSenderId: "145475975078",
            appId: "1:145475975078:web:77dac9e151aa00f193449f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        let uploadedImages = [];
        let descriptions = {};
        let clientLogs = [];
        let token = null;
        let storeInfo = null;

        // Base URL for API server
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3000' 
            : window.location.origin;

        // Logging function
        function logClientAction(action, details = {}, level = 'info') {
            const logEntry = {
                timestamp: new Date().toISOString(),
                level,
                action,
                details,
                page: 'store_dashboard',
                userAgent: navigator.userAgent
            };
            
            clientLogs.push(logEntry);
            
            const logMethod = level === 'error' ? console.error : console.log;
            logMethod(`[${logEntry.timestamp}] [${level.toUpperCase()}] ${action}`, details);
            
            if (clientLogs.length > 100) {
                clientLogs = clientLogs.slice(-100);
            }
            
            if (clientLogs.length % 10 === 0 || level === 'error') {
                sendLogsToServer();
            }
        }

        // Send logs to server
        async function sendLogsToServer() {
            const logsToSend = [...clientLogs];
            clientLogs = [];
            
            try {
                const response = await fetch(`${API_URL}/client-logs`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ logs: logsToSend })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send logs to server');
                }
            } catch (error) {
                console.error('Error sending logs to server:', error);
                clientLogs = [...clientLogs, ...logsToSend];
            }
        }

        // Login function
        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorMessage = document.getElementById('errorMessage');
            
            if (!email || !password) {
                errorMessage.textContent = 'Please enter both email and password';
                errorMessage.style.display = 'block';
                logClientAction('login_failed', { reason: 'missing credentials' }, 'error');
                return;
            }

            try {
                logClientAction('login_attempt', { email });
                console.log('Attempting login with:', email);
                
                showNotification('Logging in...', 'info');
                
                const response = await fetch(`${API_URL}/store/login`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'  // Important: include credentials for cookies
                });

                console.log('Login response status:', response.status);
                
                if (!response.ok) {
                    // Try to parse error message from response
                    let errorMsg = 'Login failed';
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorData.message || errorMsg;
                    } catch (e) {
                        // Fallback to status text if JSON parsing fails
                        errorMsg = `Login failed: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }
                
                // Successfully logged in
                const result = await response.json();
                token = result.token || 'session-auth';
                console.log('Login response body:', result);
                
                // Update session state
                window.sessionState = window.sessionState || {};
                window.sessionState.isAuthenticated = true;
                window.sessionState.sessionChecked = true;
                
                // Save token if available
                token = result.token || 'session-auth'; // Server may not return token if using session auth
                if (result.token) {
                    localStorage.setItem('storeToken', result.token);
                }
                
                // Update UI
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                errorMessage.style.display = 'none';
                
                // Log success
                logClientAction('login_success', { email });
                showNotification('Login successful!', 'success', 3000);
                
                // Load store profile to get store info
                try {
                    const profileData = await loadStoreProfile();
                    if (profileData) {
                        storeInfo = profileData;
                        window.sessionState.storeId = profileData.store_id || profileData.id;
                        window.sessionState.storeName = profileData.store_name;
                        console.log('Store profile loaded:', storeInfo);
                        fetchImages();
                    } else {
                        console.error('Store profile data is null or undefined');
                        showNotification('Could not load store profile. Please try again.', 'error');
                        
                        // Show error in login container for better visibility
                        document.getElementById('loginContainer').style.display = 'block';
                        document.getElementById('mainContainer').style.display = 'none';
                        errorMessage.textContent = 'Login successful but could not load your store profile. Please try again.';
                        errorMessage.style.display = 'block';
                    }
                } catch (profileError) {
                    console.error('Error loading store profile after login:', profileError);
                    showNotification('Logged in but could not load store profile: ' + profileError.message, 'error');
                    
                    // Show error in login container
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                    errorMessage.textContent = 'Login successful but could not load your store profile: ' + profileError.message;
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login failed: ' + error.message, 'error');
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
                logClientAction('login_error', { message: error.message }, 'error');
            }
        }

        // Fetch images
        async function fetchImages() {
            logClientAction('fetch_images_started');
            const spinner = document.getElementById('spinner');
            const gallery = document.getElementById('imageGallery');
            spinner.classList.add('active');
            gallery.innerHTML = '';

            try {
                if (!storeInfo || !window.sessionState.isAuthenticated) {
                    storeInfo = await loadStoreProfile();
                    if (!storeInfo) throw new Error('Could not load store profile');
                }

                const storeName = storeInfo.store_name;
                logClientAction('fetching_store_specific_images');

                const response = await fetch(`${API_URL}/store/garments/${storeName}`, {
                    credentials: 'include',
                    headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    uploadedImages = result.garments || [];
                    descriptions = {};
                    result.garments.forEach(garment => {
                        descriptions[garment.id] = { color: garment.color, garmentType: garment.garmentType, name: garment.name };
                    });
                    displayImages();
                    updateRemainingCounter(uploadedImages.length);
                    spinner.classList.remove('active');
                    showNotification(`Loaded ${uploadedImages.length} garments successfully`, 'success', 3000);
                    return;
                } else if (response.status === 401 || response.status === 403) {
                    throw new Error('Authentication failed. Falling back to Firestore.');
                }

                // Fallback to Firestore
                showNotification('Fetching garments from database...', 'info');
                await fetchImagesFromFirebase(storeName);
            } catch (error) {
                logClientAction('fetch_images_failed', { message: error.message }, 'error');
                console.error('Error fetching images:', error);
                if (error.message.includes('Authentication failed')) {
                    showNotification('Session expired. Please log in again.', 'warning');
                    localStorage.removeItem('storeToken');
                    token = null;
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                } else {
                    await fetchImagesFromFirebase(storeName); // Try Firestore as fallback
                }
            } finally {
                spinner.classList.remove('active');
            }
        }

        async function fetchImagesFromFirebase(storeName) {
            logClientAction('fetching_from_firebase');
            showNotification('Loading garments from database...', 'info');
            
            try {
                const sanitizedStoreName = storeName.toLowerCase().replace(/\s+/g, '_');
                
                const garmentInfoRef = firebase.firestore().collection('garments').doc('information');
                const garmentInfoDoc = await garmentInfoRef.get();
                
                if (garmentInfoDoc.exists) {
                    const garmentData = garmentInfoDoc.data();
                    const storeGarments = Object.entries(garmentData)
                        .filter(([id, data]) => data.store === storeName)
                        .map(([id, data]) => ({
                            id,
                            url: data.url,
                            public_id: data.public_id,
                            color: data.color,
                            garmentType: data.type,
                            name: data.name
                        }));
                        
                    if (storeGarments.length > 0) {
                        uploadedImages = storeGarments;
                        
                        descriptions = {};
                        storeGarments.forEach(garment => {
                            descriptions[garment.id] = {
                                color: garment.color,
                                garmentType: garment.garmentType || garment.type,
                                name: garment.name
                            };
                        });
                        
                        displayImages();
                        updateRemainingCounter(uploadedImages.length);
                        return;
                    }
                }
                
                const collections = await firebase.firestore().listCollections();
                const storeCollections = collections.filter(col => 
                    col.id.startsWith(`${sanitizedStoreName}_`)
                );
                
                if (storeCollections.length > 0) {
                    console.log(`Found ${storeCollections.length} collections for store ${storeName}`);
                    let allGarments = [];
                    
                    for (const collection of storeCollections) {
                        const infoDoc = await collection.doc('information').get();
                        if (infoDoc.exists) {
                            const data = infoDoc.data();
                            allGarments.push({
                                id: collection.id,
                                url: data.url,
                                public_id: data.public_id,
                                color: data.color,
                                garmentType: data.type,
                                name: data.name
                            });
                        }
                    }
                    
                    if (allGarments.length > 0) {
                        uploadedImages = allGarments;
                        
                        descriptions = {};
                        allGarments.forEach(garment => {
                            descriptions[garment.id] = {
                                color: garment.color,
                                garmentType: garment.garmentType || garment.type,
                                name: garment.name
                            };
                        });
                        
                        displayImages();
                        updateRemainingCounter(uploadedImages.length);
                        return;
                    }
                }
                
                const legacyCollections = collections.filter(col => 
                    col.id.startsWith(`store_${sanitizedStoreName}_`)
                );
                
                if (legacyCollections.length > 0) {
                    let legacyGarments = [];
                    
                    for (const collection of legacyCollections) {
                        const garmentDocs = await collection.get();
                        if (!garmentDocs.empty) {
                            garmentDocs.forEach(doc => {
                                const data = doc.data();
                                legacyGarments.push({
                                    id: doc.id,
                                    url: data.url,
                                    public_id: data.public_id,
                                    color: data.color,
                                    garmentType: data.type || data.garmentType,
                                    name: data.name || `${data.color} ${data.type || data.garmentType}`
                                });
                            });
                        }
                    }
                    
                    if (legacyGarments.length > 0) {
                        uploadedImages = legacyGarments;
                        
                        descriptions = {};
                        legacyGarments.forEach(garment => {
                            descriptions[garment.id] = {
                                color: garment.color,
                                garmentType: garment.garmentType,
                                name: garment.name
                            };
                        });
                        
                        displayImages();
                        updateRemainingCounter(uploadedImages.length);
                        return;
                    }
                }
                
                const legacySnapshot = await firebase.firestore()
                    .collection('image_descriptions')
                    .where('storeId', '==', storeName)
                    .get();
                    
                if (!legacySnapshot.empty) {
                    const legacyGarments = [];
                    legacySnapshot.forEach(doc => {
                        const data = doc.data();
                        const publicId = doc.id;
                        const cloudinaryPath = publicId.replace(/_/g, '/');
                        const url = `https://res.cloudinary.com/dj3ewvbqm/image/upload/${cloudinaryPath}`;
                        
                        legacyGarments.push({
                            id: publicId,
                            url: url,
                            public_id: cloudinaryPath,
                            color: data.color,
                            garmentType: data.garmentType,
                            name: data.garmentName || `${data.color} ${data.garmentType}`
                        });
                    });
                    
                    if (legacyGarments.length > 0) {
                        uploadedImages = legacyGarments;
                        
                        descriptions = {};
                        legacyGarments.forEach(garment => {
                            descriptions[garment.id] = {
                                color: garment.color,
                                garmentType: garment.garmentType,
                                name: garment.name
                            };
                        });
                        
                        displayImages();
                        updateRemainingCounter(uploadedImages.length);
                        return;
                    }
                }
                
                logClientAction('no_garments_found');
                showNotification('No garments found for this store.', 'warning');
                
            } catch (error) {
                console.error('Error fetching from Firebase:', error);
                logClientAction('firebase_fetch_error', { message: error.message }, 'error');
                showNotification('Error loading garments from database.', 'error');
            }
        }

        async function fetchOrders() {
            logClientAction('fetch_orders_started');
            const spinner = document.getElementById('ordersSpinner');
            const ordersList = document.getElementById('ordersList');
            spinner.classList.add('active');
            ordersList.innerHTML = '';

            try {
                if (!storeInfo || !window.sessionState.isAuthenticated) {
                    storeInfo = await loadStoreProfile();
                    if (!storeInfo) throw new Error('Could not load store profile');
                }

                const storeName = storeInfo.store_name;
                if (!storeName) {
                    throw new Error('Store name not available. Please refresh the page and try again.');
                }

                logClientAction('fetching_orders_for_store', { storeName });

                const response = await fetch(`${API_URL}/store/orders/${storeName}`, {
                    credentials: 'include',
                    headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch orders: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                if (result.orders && result.orders.length > 0) {
                    result.orders.forEach(order => {
                        const orderItem = document.createElement('div');
                        orderItem.className = 'order-item';
                        orderItem.innerHTML = `
                            The customer ${order.name} notified that he wants to buy that garment ${order.garmentName}. 
                            Please contact him on that phone number ${order.phone}.
                        `;
                        ordersList.appendChild(orderItem);
                    });
                    showNotification(`Loaded ${result.orders.length} order(s) successfully`, 'success', 3000);
                } else {
                    ordersList.innerHTML = '<p>No pending orders found.</p>';
                }
            } catch (error) {
                logClientAction('fetch_orders_failed', { message: error.message }, 'error');
                console.error('Error fetching orders:', error);
                ordersList.innerHTML = `
                    <div class="error-container" style="text-align: center; padding: 20px; color: #ff4444;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>Failed to load orders</h3>
                        <p>${error.message || 'Please check your connection and try again.'}</p>
                        <button class="btn" onclick="fetchOrders()" style="margin-top: 15px;">
                            <i class="fas fa-sync"></i> Try Again
                        </button>
                    </div>
                `;
                showNotification('Failed to load orders: ' + error.message, 'error');
            } finally {
                spinner.classList.remove('active');
            }
        }

        // Upload images
        async function uploadImages() {
            const imageInput = document.getElementById('imageInput');
            const colorSelect = document.getElementById('colorSelect');
            const garmentTypeSelect = document.getElementById('garmentTypeSelect');
            const garmentNameInput = document.getElementById('garmentNameInput');
            const uploadButton = document.getElementById('uploadButton');
            const spinner = document.getElementById('spinner');
            
            if (!storeInfo || !storeInfo.store_name) {
                logClientAction('upload_failed_no_store_info', {}, 'error');
                showNotification('Could not determine store information. Please refresh and try again.', 'error');
                return;
            }
            
            if (!imageInput.files.length) {
                logClientAction('upload_no_files', {}, 'warn');
                showNotification('Please select at least one image', 'warning');
                return;
            }
            
            if (!colorSelect.value) {
                logClientAction('upload_no_color', {}, 'warn');
                showNotification('Please select a color', 'warning');
                return;
            }
            
            if (!garmentTypeSelect.value) {
                logClientAction('upload_no_garment_type', {}, 'warn');
                showNotification('Please select a garment type', 'warning');
                return;
            }
            
            const customName = garmentNameInput.value.trim();
            const garmentName = customName || `${colorSelect.value} ${garmentTypeSelect.value}`;
            
            const sanitizedStoreName = storeInfo.store_name.replace(/\s+/g, '_').toLowerCase();
            const storeFolder = `store_${sanitizedStoreName}_garments`;
            
            if (uploadedImages.length >= 6) {
                logClientAction('upload_limit_reached', { current: uploadedImages.length }, 'warn');
                showNotification('You have reached the maximum number of images (6)', 'error');
                return;
            }
            
            uploadButton.disabled = true;
            spinner.classList.add('active');
            logClientAction('upload_started', { garmentName });
            showNotification('Uploading garment...', 'info');
            
            try {
                const files = Array.from(imageInput.files);
                
                if (files.length + uploadedImages.length > 6) {
                    logClientAction('upload_would_exceed_limit', { 
                        current: uploadedImages.length,
                        attempting: files.length 
                    }, 'warn');
                    showNotification(`Cannot upload ${files.length} images. You can only upload ${6 - uploadedImages.length} more.`, 'error');
                    return;
                }
                
                const formData = new FormData();
                for (let file of files) {
                    formData.append('images', file);
                }
                formData.append('color', colorSelect.value);
                formData.append('garmentType', garmentTypeSelect.value);
                formData.append('garmentName', garmentName);
                formData.append('folder', storeFolder);
                formData.append('storeName', storeInfo.store_name);

                logClientAction('sending_upload_request', { garmentName });
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const responseData = await response.json().catch(() => ({ error: 'Upload failed' }));
                    logClientAction('upload_failed', { status: response.status, error: responseData.error }, 'error');
                    throw new Error(responseData.error || 'Upload failed');
                }
                
                const result = await response.json();
                
                if (result.images) {
                    uploadedImages = [...uploadedImages, ...result.images.map(img => ({
                        url: img.url,
                        public_id: img.public_id,
                        id: img.garmentId || img.public_id,
                        color: colorSelect.value,
                        garmentType: garmentTypeSelect.value,
                        name: garmentName
                    }))];
                    
                    logClientAction('upload_success', { count: result.images.length, garmentName });
                    showNotification(`Successfully uploaded ${result.images.length} garment(s)!`, 'success');
                    
                    await fetchImages();
                    
                    imageInput.value = '';
                    colorSelect.value = '';
                    garmentTypeSelect.value = '';
                    garmentNameInput.value = '';
                    logClientAction('form_reset');
                }
            } catch (error) {
                logClientAction('upload_error', { message: error.message }, 'error');
                console.error('Upload error:', error);
                showNotification('Failed to process images: ' + error.message, 'error');
            } finally {
                uploadButton.disabled = false;
                spinner.classList.remove('active');
            }
        }

        // Delete image
        async function deleteImage(imageId) {
            logClientAction('delete_started', { imageId });
            const spinner = document.getElementById('spinner');
            spinner.classList.add('active');
            showNotification('Deleting garment...', 'info');
            
            try {
                const imageToDelete = uploadedImages.find(img => img.id === imageId || img.public_id === imageId);
                if (!imageToDelete) {
                    throw new Error('Image not found in local cache');
                }
                
                let publicId = imageToDelete.public_id;
                
                if (publicId.includes('/')) {
                    publicId = encodeURIComponent(publicId);
                }
                
                console.log('Attempting to delete image with public ID:', publicId);
                
                try {
                    const deleteUrl = `${API_URL}/delete/${publicId}`;
                    console.log('Delete URL:', deleteUrl);
                    
                    const response = await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: { 
                            'Authorization': token ? `Bearer ${token}` : '',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    const responseText = await response.text();
                    console.log('Server delete response:', responseText);
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        result = { success: false, error: responseText || 'Unknown error' };
                    }
                    
                    if (!response.ok) {
                        logClientAction('server_delete_failed', { 
                            imageId, 
                            status: response.status, 
                            error: result.error || 'Delete failed' 
                        }, 'error');
                        console.warn('Server deletion failed, falling back to Firebase:', result.error || responseText);
                    } else {
                        if (result.success) {
                            logClientAction('server_delete_success', { imageId });
                            console.log('Server deletion successful');
                        } else {
                            logClientAction('server_delete_failed', { imageId, error: result.error || 'Unknown error' });
                            console.warn('Server deletion returned success=false, reason:', result.error);
                        }
                    }
                } catch (serverError) {
                    console.warn('Error during server deletion:', serverError);
                }
                
                try {
                    await deleteFromFirebase(imageId, imageToDelete);
                } catch (firebaseError) {
                    console.warn('Firebase deletion failed, but continuing with UI update:', firebaseError);
                }
                
                uploadedImages = uploadedImages.filter(img => img.id !== imageId && img.public_id !== imageId);
                descriptions = { ...descriptions };
                delete descriptions[imageId];
                
                displayImages();
                updateRemainingCounter(uploadedImages.length);
                showNotification('Garment deleted successfully.', 'success');
            } catch (error) {
                logClientAction('delete_error', { imageId, message: error.message }, 'error');
                console.error('Delete error:', error);
                showNotification('Failed to delete image: ' + error.message, 'error');
            } finally {
                spinner.classList.remove('active');
            }
        }

        async function deleteFromFirebase(imageId, imageData) {
            if (!firebase || !firebase.firestore) {
                console.warn('Firebase not available for deletion');
                return;
            }
            
            try {
                const db = firebase.firestore();
                const storeName = storeInfo?.store_name || 'unknown_store';
                const garmentType = imageData?.garmentType || imageData?.type || 'unknown_type';
                
                const pendingDeletions = JSON.parse(localStorage.getItem('pending_deletions') || '[]');
                pendingDeletions.push({
                    imageId,
                    publicId: imageData.public_id,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('pending_deletions', JSON.stringify(pendingDeletions));
                
                if (!navigator.onLine) {
                    console.log('Browser is offline, storing delete request for later');
                    return true;
                }
                
                const safeDelete = async (collectionPath, docId) => {
                    try {
                        await db.collection(collectionPath).doc(docId).delete();
                        return true;
                    } catch (err) {
                        console.warn(`Could not delete ${collectionPath}/${docId}:`, err);
                        return false;
                    }
                };
                
                const deleteTasks = [];
                
                deleteTasks.push(
                    db.collection('garments').doc('information').update({
                        [imageId]: firebase.firestore.FieldValue.delete()
                    }).catch(err => console.warn('Could not update garments/information:', err))
                );
                
                if (imageId.includes('_')) {
                    deleteTasks.push(safeDelete(imageId, 'information'));
                }
                
                const sanitizedStoreName = storeName.toLowerCase().replace(/\s+/g, '_');
                const sanitizedType = garmentType.toLowerCase().replace(/\s+/g, '_');
                const collectionName = `store_${sanitizedStoreName}_${sanitizedType}`;
                deleteTasks.push(safeDelete(collectionName, imageId));
                
                const publicId = imageData.public_id;
                if (publicId) {
                    const safeDocId = publicId.replace(/\//g, '_');
                    deleteTasks.push(safeDelete('image_descriptions', safeDocId));
                }
                
                await Promise.allSettled(deleteTasks);
                
                logClientAction('firebase_delete_success', { imageId });
                return true;
            } catch (error) {
                console.error('Error deleting from Firebase:', error);
                logClientAction('firebase_delete_error', { imageId, error: error.message }, 'error');
                return false;
            }
        }

        // Display images
        function displayImages() {
            const gallery = document.getElementById('imageGallery');
            gallery.innerHTML = '';
            
            uploadedImages.forEach(image => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                
                const imageId = image.id || image.public_id;
                const imagePublicId = image.public_id;
                
                const desc = descriptions[imageId] || descriptions[imagePublicId] || { 
                    color: image.color || 'Unknown', 
                    garmentType: image.garmentType || 'Unknown',
                    name: image.name || `${image.color || 'Unknown'} ${image.garmentType || 'Garment'}`
                };
                
                imageItem.innerHTML = `
                    <img src="${image.url}" alt="${desc.name || 'Garment'}" onerror="this.src='MetaVrLogo.jpg'">
                    <div class="image-description">
                        <h3 class="garment-name">${desc.name || `${desc.color} ${desc.garmentType}`}</h3>
                        <div class="garment-details">
                            <span class="garment-color">
                                <span class="color-dot" style="background-color: ${desc.color.toLowerCase()};"></span>
                                ${desc.color}
                            </span>
                            <span class="garment-type">${desc.garmentType}</span>
                        </div>
                    </div>
                    <button class="delete-button" onclick="deleteImage('${imageId}')">Delete</button>
                `;
                gallery.appendChild(imageItem);
            });
            
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                .image-item {
                    position: relative;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    transition: transform 0.2s, box-shadow 0.2s;
                    margin-bottom: 20px;
                }
                
                .image-item:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                }
                
                .image-item img {
                    width: 100%;
                    height: 200px;
                    object-fit: contain;
                    background: #f9f9f9;
                }
                
                .image-description {
                    padding: 10px 15px;
                }
                
                .garment-name {
                    margin: 0 0 8px 0;
                    font-size: 16px;
                    font-weight: 600;
                    color: #333;
                }
                
                .garment-details {
                    display: flex;
                    justify-content: space-between;
                    font-size: 14px;
                    color: #666;
                }
                
                .color-dot {
                    display: inline-block;
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    margin-right: 5px;
                }
                
                .delete-button {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 255, 255, 0.8);
                    border: none;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    cursor: pointer;
                    color: #ff4444;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0.7;
                    transition: opacity 0.2s, background 0.2s;
                }
                
                .delete-button:hover {
                    opacity: 1;
                    background: white;
                }
            `;
            
            if (!document.getElementById('garment-styles')) {
                styleElement.id = 'garment-styles';
                document.head.appendChild(styleElement);
            }
        }

        // Update remaining counter
        function updateRemainingCounter(currentCount) {
            const remaining = 6 - currentCount;
            const counter = document.getElementById('remainingCounter');
            counter.textContent = `Remaining: ${remaining}/6`;
            if (remaining === 0) {
                counter.style.color = '#ff4444';
            } else {
                counter.style.color = 'var(--text)';
            }
        }

        // Switch between tabs
        function switchTab(tab) {
            const garmentsTab = document.querySelector('.nav-tab:nth-child(1)');
            const ordersTab = document.querySelector('.nav-tab:nth-child(2)');
            const garmentsContainer = document.getElementById('garmentsContainer');
            const ordersContainer = document.getElementById('ordersContainer');
            
            if (tab === 'garments') {
                garmentsTab.classList.add('active');
                ordersTab.classList.remove('active');
                garmentsContainer.style.display = 'block';
                ordersContainer.style.display = 'none';
                fetchImages(); // Refresh garments
            } else if (tab === 'orders') {
                ordersTab.classList.add('active');
                garmentsTab.classList.remove('active');
                ordersContainer.style.display = 'block';
                garmentsContainer.style.display = 'none';
                fetchOrders(); // Refresh orders
            }
        }

        // Check for existing token or session
        window.onload = function() {
            logClientAction('page_loaded');
            
            showNotification('Checking session...', 'info');
            
            window.sessionState = {
                isAuthenticated: false,
                sessionChecked: false,
                tokenChecked: false,
                storeId: null,
                storeName: null
            };
            
            fetch(`${API_URL}/store/profile`, {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }).then(response => {
                console.log('Session check response status:', response.status);
                window.sessionState.sessionChecked = true;
                
                if (response.status === 200) {
                    window.sessionState.isAuthenticated = true;
                    showNotification('Active session found!', 'success', 3000);
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    
                    return response.json().then(profileData => {
                        storeInfo = profileData;
                        window.sessionState.storeId = profileData.store_id || profileData.id;
                        window.sessionState.storeName = profileData.store_name;
                        updateStoreUI(profileData);
                        fetchImages();
                        fetchOrders();
                    });
                } else if (response.status === 401 || response.status === 400) {
                    showNotification('No active session, checking for saved token...', 'info');
                    
                    const savedToken = localStorage.getItem('storeToken');
                    if (savedToken) {
                        token = savedToken;
                        return checkSavedToken(savedToken);
                    } else {
                        showNotification('Please log in to continue', 'info');
                        document.getElementById('loginContainer').style.display = 'block';
                        document.getElementById('mainContainer').style.display = 'none';
                        return false;
                    }
                } else {
                    throw new Error(`Session check failed with status: ${response.status}`);
                }
            }).catch(error => {
                console.error('Error checking session:', error);
                showNotification('Session check failed: ' + error.message, 'error', 6000);
                
                if (!window.sessionState.tokenChecked) {
                    const savedToken = localStorage.getItem('storeToken');
                    if (savedToken) {
                        return checkSavedToken(savedToken);
                    }
                }
                
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
                logClientAction('session_check_error', { message: error.message }, 'error');
            });
        };
        
        function checkSavedToken(savedToken) {
            window.sessionState.tokenChecked = true;
            token = savedToken;
            
            return fetch(`${API_URL}/store/profile`, {
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                },
                credentials: 'include'
            }).then(response => {
                if (response.ok) {
                    window.sessionState.isAuthenticated = true;
                    showNotification('Authenticated with saved token!', 'success', 3000);
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    
                    return response.json().then(profileData => {
                        storeInfo = profileData;
                        window.sessionState.storeId = profileData.store_id || profileData.id;
                        window.sessionState.storeName = profileData.store_name;
                        updateStoreUI(profileData);
                        fetchImages();
                        fetchOrders();
                        return true;
                    });
                } else {
                    localStorage.removeItem('storeToken');
                    token = null;
                    showNotification('Saved token is invalid. Please log in again.', 'warning');
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                    return false;
                }
            }).catch(err => {
                console.error('Error checking token:', err);
                localStorage.removeItem('storeToken');
                token = null;
                showNotification('Error checking saved credentials. Please log in again.', 'error');
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
                return false;
            });
        }
        
        function updateStoreUI(profileData) {
            if (profileData.store_name) {
                document.title = `${profileData.store_name} - Store Dashboard`;
                showNotification(`Welcome to ${profileData.store_name} dashboard`, 'success', 3000);
            }
            
            if (profileData.logo_link) {
                const headerLogo = document.getElementById('storeLogo');
                if (headerLogo) {
                    headerLogo.src = profileData.logo_link;
                    headerLogo.alt = `${profileData.store_name} Logo`;
                    headerLogo.onerror = function() {
                        this.src = 'MetaVrLogo.jpg';
                        console.warn('Failed to load store logo, falling back to default');
                    };
                }
            }
            
            const heading = document.getElementById('storeHeading');
            if (heading && profileData.store_name) {
                heading.textContent = `${profileData.store_name} - Dashboard`;
            }
        }

        async function loadStoreProfile() {
            console.log('Loading store profile...');
            try {
                showNotification('Loading store profile...', 'info');
                
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`${API_URL}/store/profile`, {
                    method: 'GET',
                    headers,
                    credentials: 'include'
                });
                
                console.log('Store profile response status:', response.status);
                
                if (response.status === 200) {
                    const data = await response.json();
                    console.log('Store profile data received:', data);
                    
                    window.sessionState.isAuthenticated = true;
                    window.sessionState.storeId = data.store_id || data.id;
                    window.sessionState.storeName = data.store_name;
                    
                    updateStoreUI(data);
                    
                    return data;
                } else if (response.status === 401) {
                    throw new Error('Authentication expired. Please log in again.');
                } else if (response.status === 400) {
                    try {
                        const errorData = await response.json();
                        if (errorData.error) {
                            throw new Error(errorData.error);
                        } else {
                            throw new Error('Store profile request failed');
                        }
                    } catch (e) {
                        throw new Error('Store profile request failed: ' + (e.message || 'Unknown error'));
                    }
                } else {
                    throw new Error(`Failed to load store profile: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading store profile:', error);
                
                if (error.message.includes('Authentication expired') || 
                    error.message.includes('not found in session') ||
                    error.message.includes('not authenticated')) {
                    showNotification('Your session has expired. Please log in again.', 'warning');
                    localStorage.removeItem('storeToken');
                    token = null;
                    document.getElementById('loginContainer').style.display = 'block';
                    document.getElementById('mainContainer').style.display = 'none';
                } else {
                    showNotification('Error loading store profile: ' + error.message, 'error');
                }
                
                return null;
            }
        }

        async function debugSession() {
            console.log('Checking session debug information...');
            try {
                showNotification('Checking session...', 'info');
                
                const response = await fetch(`${API_URL}/debug-session-public`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                console.log('Session debug information:', data);
                
                if (data.sessionInfo.hasSession) {
                    if (data.sessionInfo.userPresent) {
                        showNotification(
                            `Session exists with role: ${data.sessionInfo.userRole}. ` +
                            `Store ID: ${data.sessionInfo.storeId || 'none'}`, 
                            'info', 
                            10000
                        );
                    } else {
                        showNotification('Session exists but no user data found!', 'warning', 10000);
                    }
                } else {
                    showNotification('No active session found!', 'warning', 10000);
                }
                
                if (!data.sessionInfo.isStore) {
                    const loginContainer = document.getElementById('loginContainer');
                    const testAccountsBtn = document.createElement('button');
                    testAccountsBtn.innerHTML = 'Use Test Account';
                    testAccountsBtn.style.marginTop = '10px';
                    testAccountsBtn.onclick = function() {
                        document.getElementById('emailInput').value = 'Nike@metevr.shop';
                        document.getElementById('passwordInput').value = 'Nike@metaVrAdmin';
                        showNotification('Test credentials loaded! Click Login to continue.', 'info');
                    };
                    
                    if (!loginContainer.querySelector('button[test-account]')) {
                        loginContainer.appendChild(testAccountsBtn);
                    }
                }
            } catch (error) {
                console.error('Error checking session:', error);
                showNotification('Error checking session: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'info', duration = 5000) {
            const notificationBar = document.getElementById('notificationBar');
            notificationBar.textContent = message;
            
            if (type === 'error') {
                notificationBar.style.backgroundColor = '#ff4444';
                notificationBar.style.color = 'white';
            } else if (type === 'success') {
                notificationBar.style.backgroundColor = '#4CAF50';
                notificationBar.style.color = 'white';
            } else if (type === 'warning') {
                notificationBar.style.backgroundColor = '#ff9800';
                notificationBar.style.color = 'white';
            } else {
                notificationBar.style.backgroundColor = '#2196F3';
                notificationBar.style.color = 'white';
            }
            
            notificationBar.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    notificationBar.style.display = 'none';
                }, duration);
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Try-On Experience</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --background: #f5f5f5;
      --card-background: #ffffff;
      --text: #333333;
      --text-light: #666666;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
      --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      --background: #1a1a1a;
      --card-background: #2c2c2c;
      --text: #ffffff;
      --text-light: #b0b0b0;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--background);
      color: var(--text);
      margin: 0;
      padding: 0;
      transition: var(--transition);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header-logo {
      width: 100px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.2rem;
      color: var(--text-light);
    }

    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text);
    }

    .progress-stepper {
      display: flex;
      justify-content: space-between;
      margin: 40px 0;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      background-color: #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      transition: var(--transition);
    }

    .step.active .step-circle {
      background-color: var(--primary);
      color: #fff;
    }

    .step-text {
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .card {
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }

    h2 {
      font-size: 1.8rem;
      margin-bottom: 10px;
    }

    p {
      color: var(--text-light);
      margin-bottom: 20px;
    }

    .store-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .store-card {
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      opacity: 0.5;
    }

    .store-card.loaded {
      opacity: 1;
    }

    .store-card:hover, .store-card.selected {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .store-card.selected {
      border: 2px solid var(--primary);
    }

    .store-logo-container {
      width: 100%;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      overflow: hidden;
    }

    .store-logo-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .garment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
    }

    .garment-item {
      position: relative;
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      opacity: 0.5;
    }

    .garment-item.loaded {
      opacity: 1;
    }

    .garment-item:hover, .garment-item.selected {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .garment-item.selected {
      border: 2px solid var(--primary);
    }

    .garment-item img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: var(--border-radius);
      margin-bottom: 10px;
    }

    .garment-check {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: var(--primary);
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: var(--transition);
    }

    .garment-item.selected .garment-check {
      opacity: 1;
    }

    .camera-container {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .camera-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
    }

    video {
      width: 100%;
      display: block;
    }

    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 10px solid rgba(255, 255, 255, 0.3);
      box-sizing: border-box;
      pointer-events: none;
    }

    .flash {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #fff;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .flash.active {
      opacity: 0.7;
    }

    .timer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      color: #fff;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: var(--border-radius);
      display: none;
    }

    .camera-instructions {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 10px;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      text-align: center;
    }

    .camera-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .camera-control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .camera-control-btn.primary {
      background-color: var(--primary);
      color: #fff;
    }

    .camera-control-btn.secondary {
      background-color: var(--text-light);
      color: #fff;
    }

    .error-message {
      color: var(--danger);
      text-align: center;
      margin-top: 10px;
    }

    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .preview-card {
      flex: 1;
      min-width: 250px;
      background-color: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .preview-header {
      background-color: var(--primary);
      color: #fff;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }

    .preview-body {
      padding: 15px;
      text-align: center;
    }

    .preview-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: var(--border-radius);
    }

    .preview-details {
      margin-top: 10px;
      text-align: left;
    }

    .preview-detail-item {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
    }

    .result-container {
      margin-top: 40px;
      text-align: center;
    }

    .output-id {
      margin-top: 10px;
      color: var(--text-light);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background-color: var(--primary);
      color: #fff;
    }

    .btn-success {
      background-color: var(--success);
      color: #fff;
    }

    .btn-success:hover {
      background-color: #218838;
    }

    .btn-warning {
      background-color: var(--warning);
      color: #212529;
    }

    .btn-warning:hover {
      background-color: #e0a800;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
    }

    .overlay.show {
      display: block;
    }

    .popup-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--card-background);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      max-width: 400px;
      width: 90%;
      z-index: 1001;
      display: none;
    }

    .popup-form.show {
      display: block;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      box-sizing: border-box;
    }

    .form-group input.error {
      border-color: var(--danger);
    }

    .form-details {
      margin: 20px 0;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: var(--border-radius);
    }

    .form-detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .detail-label {
      font-weight: bold;
    }

    .form-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .required-message {
      color: var(--danger);
      text-align: center;
      margin-top: 10px;
      display: none;
    }

    .required-message.visible {
      display: block;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--card-background);
      padding: 10px 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1002;
      display: none;
    }

    .toast.show {
      display: flex;
    }

    .toast-icon {
      font-size: 1.5rem;
    }

    .toast-close {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      color: var(--text-light);
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tryon-progress-bar {
      width: 100%;
      height: 10px;
      background-color: #f0f0f0;
      overflow: hidden;
      position: relative;
      margin-top: 20px;
      border-radius: var(--border-radius);
    }

    .tryon-progress-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 50%;
      height: 100%;
      background-color: var(--primary);
      animation: progress 1.5s infinite linear;
    }

    @keyframes progress {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(200%);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      h1 {
        font-size: 2rem;
      }

      .progress-stepper {
        flex-direction: column;
        gap: 10px;
      }

      .step {
        flex: none;
      }

      .preview-container {
        flex-direction: column;
        align-items: center;
      }

      .preview-card {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <div class="toast-icon">
      <i id="toastIcon" class="fas fa-info-circle"></i>
    </div>
    <span id="toastMessage"></span>
    <button class="toast-close" id="toastClose" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- User Info Form Overlay -->
  <div class="overlay" id="formOverlay"></div>
  <div class="popup-form" id="userInfoForm">
    <h3>Enter Your Details</h3>
    <button id="closeFormBtn" class="btn btn-outline" style="position: absolute; top: 10px; right: 10px;">Close</button>
    <p style="margin-bottom: 15px; color: var(--text-light); text-align: center;">Please provide your contact information to complete this action.</p>
    <div class="form-group">
      <label for="userName"><i class="fas fa-user"></i> Name *</label>
      <input type="text" id="userName" placeholder="Enter your name" required autocomplete="name">
    </div>
    <div class="form-group">
      <label for="userPhone"><i class="fas fa-phone"></i> Phone Number *</label>
      <input type="tel" id="userPhone" placeholder="Enter your phone number" required autocomplete="tel">
      <small style="display: block; margin-top: 5px; color: var(--text-light);">Format: +1 234 567 8900 or 2345678900</small>
    </div>
    <div class="form-details">
      <div class="form-detail-row">
        <span class="detail-label">Store:</span>
        <span class="detail-value" id="formStoreDetail">Loading...</span>
      </div>
      <div class="form-detail-row">
        <span class="detail-label">Garment:</span>
        <span class="detail-value" id="formGarmentDetail">Loading...</span>
      </div>
    </div>
    <div class="form-buttons">
      <button id="submitFormBtn" class="btn btn-success"><i class="fas fa-check"></i> Submit</button>
    </div>
    <div class="required-message">
      <i class="fas fa-info-circle"></i> This information is required to proceed
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <header>
      <img src="MetaVrLogo.jpg" alt="MetaVR Logo" class="header-logo">
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
        <i class="fas fa-moon"></i>
      </button>
      <h1>Virtual Try-On Experience</h1>
      <p class="subtitle">Experience the future of shopping with our AI-powered virtual try-on</p>
      <div class="progress-stepper" data-progress="1">
        <div class="step active" data-step="1"><div class="step-circle">1</div><div class="step-text">Store Selection</div></div>
        <div class="step" data-step="2"><div class="step-circle">2</div><div class="step-text">Select Garment</div></div>
        <div class="step" data-step="3"><div class="step-circle">3</div><div class="step-text">Upload Image</div></div>
        <div class="step" data-step="4"><div class="step-circle">4</div><div class="step-text">TryOn Result</div></div>
      </div>
    </header>

    <!-- Step 1: Store Selection -->
    <div id="page1" class="page active">
      <div class="card">
        <h2><i class="fas fa-store"></i> Step 1: Select a Store</h2>
        <p>Choose a store to explore their garment collection</p>
        <div id="loading-stores">
          <div class="spinner"></div>
          <p>Loading available stores...</p>
        </div>
        <div id="stores-container" class="store-grid"></div>
      </div>
      <div class="navigation btn-group">
        <button id="toPage2" class="btn" disabled>Next: Select Garment <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 2: Garment Selection -->
    <div id="page2" class="page">
      <div class="card">
        <h2><i class="fas fa-tshirt"></i> Step 2: Select a Garment</h2>
        <p>Browse the collection and choose the garment you'd like to try on virtually.</p>
        <div id="garmentGrid" class="garment-grid">
          <div class="spinner" id="garmentSpinner"></div>
        </div>
        <div id="garmentError" class="error-message"></div>
      </div>
      <div class="navigation btn-group">
        <button id="backToPage1" class="btn btn-outline">Back</button>
        <button id="toPage3" class="btn" disabled>Next: Take Photo <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 3: Take Photo -->
    <div id="page3" class="page">
      <div class="card">
        <h2><i class="fas fa-camera"></i> Step 3: Take a Photo</h2>
        <p>Position yourself in the frame and click the capture button to take a photo.</p>
        <div class="camera-container">
          <div class="camera-loading" id="cameraLoading">
            <div class="spinner"></div>
            <p>Initializing camera...</p>
          </div>
          <video id="video" autoplay playsinline></video>
          <div class="camera-overlay"></div>
          <div id="flash" class="flash"></div>
          <div id="timer" class="timer">3</div>
          <div class="camera-instructions">
            <i class="fas fa-info-circle"></i> Stand in good lighting and ensure your full body is visible
          </div>
        </div>
        <div id="cameraError" class="error-message"></div>
        <div class="camera-controls">
          <button id="captureBtn" class="camera-control-btn primary"><i class="fas fa-camera"></i></button>
          <button id="switchCamera" class="camera-control-btn secondary"><i class="fas fa-sync"></i></button>
        </div>
        <div id="alternativeUpload" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ddd;">
          <h3 style="font-size: 1.1rem; margin-bottom: 15px;">Alternative: Upload an Image</h3>
          <p style="margin-bottom: 15px; color: var(--text-light);">If your camera isn't working, you can upload an image instead:</p>
          <input type="file" id="manualImageUpload" accept="image/*" style="margin-bottom: 15px;">
          <button id="uploadImageBtn" class="btn">Upload Image</button>
          <div class="spinner" id="uploadSpinner" style="display: none;"></div>
          <div style="margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ddd;">
            <button id="runDiagnosticBtn" class="btn btn-outline" style="margin-top: 10px;">
              <i class="fas fa-stethoscope"></i> Run Camera Diagnostic
            </button>
            <div id="diagnosticResult" style="margin-top: 15px; display: none;">
              <h4 style="margin-bottom: 10px;">Diagnostic Results:</h4>
              <pre id="diagnosticOutput" style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.85rem;"></pre>
            </div>
          </div>
        </div>
      </div>
      <div class="navigation btn-group">
        <button id="backToPage2" class="btn btn-outline">Back</button>
        <button id="toPage4" class="btn" disabled>Next: Preview <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Step 4: Preview and Try-On -->
    <div id="page4" class="page">
      <div class="card">
        <h2><i class="fas fa-magic"></i> Step 4: Preview and Try-On</h2>
        <p>Review your photo and selected garment, then click Try-On to see the magic happen.</p>
        <div class="preview-container">
          <div class="preview-card">
            <div class="preview-header">Your Photo</div>
            <div class="preview-body">
              <img id="userPhoto" class="preview-image" alt="Your photo">
            </div>
          </div>
          <div class="preview-card">
            <div class="preview-header">Selected Garment</div>
            <div class="preview-body">
              <img id="selectedGarment" class="preview-image" alt="Selected garment">
              <div class="preview-details">
                <div class="preview-detail-item">
                  <span>Type:</span>
                  <span id="garmentType"></span>
                </div>
                <div class="preview-detail-item">
                  <span>Color:</span>
                  <span id="garmentColor"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="btn-group" style="justify-content: center; margin-top: 20px;">
          <button id="tryOnBtn" class="btn btn-success">Try On Now <i class="fas fa-wand-magic-sparkles"></i></button>
        </div>
        <p id="trialInfo" style="text-align: center; margin-top: 10px; color: var(--text-light);"></p>
        <div id="spinner" class="spinner" style="display: none;"></div>
        <div id="tryonProgressBar" class="tryon-progress-bar" style="display: none;"></div>
        <div id="errorMessage" class="error-message"></div>
        <div id="resultContainer" class="result-container" style="display: none;">
          <h3>Try-On Result</h3>
          <img id="resultImage" alt="Try-on result" style="width: 100%; border-radius: var(--border-radius); box-shadow: var(--shadow);">
          <p id="outputId" class="output-id"></p>
          <div class="btn-group" style="justify-content: flex-start; margin-top: 20px;">
            <button id="downloadBtn" class="btn btn-outline"><i class="fas fa-download"></i> Download Result</button>
            <button id="shareBtn" class="btn btn-outline"><i class="fas fa-share"></i> Share</button>
            <button id="buyBtn" class="btn btn-success"><i class="fas fa-shopping-cart"></i> Buy Now</button>
          </div>
        </div>
      </div>
      <div class="navigation btn-group">
        <button id="backToPage3" class="btn btn-outline">Back</button>
        <button id="startOver" class="btn btn-warning">Start Over <i class="fas fa-redo"></i></button>
      </div>
    </div>
  </div>

  <canvas id="canvas" style="display: none;"></canvas>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="backend.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA2acnGWc7l7WMuocYwLp46Q-ybZx2mTt0",
      authDomain: "vton-f7059.firebaseapp.com",
      projectId: "vton-f7059",
      storageBucket: "vton-f7059.firebasestorage.app",
      messagingSenderId: "25358125157",
      appId: "1:25358125157:web:1ef4e67c9e7ba788a2de8c",
      measurementId: "G-4FKNGG88PN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global Variables
    let selectedStore = null;
    let selectedGarment = null;
    let userPhotoUrl = null;
    let jobId = null;
    let orderId = null;
    let isFormSubmitted = false;

    // Page Switching Function
    function switchPage(from, to) {
      document.getElementById(from).classList.remove('active');
      document.getElementById(to).classList.add('active');
      const stepper = document.querySelector('.progress-stepper');
      const steps = stepper.querySelectorAll('.step');
      steps.forEach(step => step.classList.remove('active'));
      stepper.querySelector(`.step[data-step="${to.slice(-1)}"]`).classList.add('active');
      stepper.setAttribute('data-progress', to.slice(-1));
    }

    // Display Stores
    function displayStores(stores) {
      const container = document.getElementById('stores-container');
      const loading = document.getElementById('loading-stores');
      loading.style.display = 'none';
      container.innerHTML = '';
      stores.forEach(store => {
        const card = document.createElement('div');
        card.className = 'store-card';
        card.innerHTML = `
          <div class="store-logo-container">
            <img src="${store.logo_link || 'default-logo.png'}" alt="${store.store_name}">
          </div>
          <h3>${store.store_name}</h3>
          <p>${store.specialization}</p>
        `;
        const img = card.querySelector('img');
        img.onload = () => {
          card.classList.add('loaded');
          console.log(`Store logo loaded for ${store.store_name}`);
        };
        img.onerror = () => {
          card.classList.add('loaded');
          console.log(`Store logo failed to load for ${store.store_name}`);
        };
        card.addEventListener('click', () => {
          selectedStore = store;
          document.getElementById('toPage2').disabled = false;
          document.querySelectorAll('.store-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
        });
        container.appendChild(card);
      });
    }

    // Display Garments
    function displayGarments(garments) {
      const grid = document.getElementById('garmentGrid');
      const spinner = document.getElementById('garmentSpinner');
      spinner.style.display = 'none';
      grid.innerHTML = '';
      garments.forEach(garment => {
        const item = document.createElement('div');
        item.className = 'garment-item';
        item.innerHTML = `
          <img src="${garment.url || 'default-garment.png'}" alt="${garment.name}">
          <div class="garment-check"><i class="fas fa-check"></i></div>
          <h4>${garment.name}</h4>
          <p>Color: ${garment.color || 'N/A'}</p>
          <p>Type: ${garment.type || 'N/A'}</p>
        `;
        const img = item.querySelector('img');
        img.onload = () => {
          item.classList.add('loaded');
          console.log(`Garment image loaded for ${garment.name}`);
        };
        img.onerror = () => {
          item.classList.add('loaded');
          console.log(`Garment image failed to load for ${garment.name}`);
        };
        item.addEventListener('click', () => {
          selectedGarment = garment;
          document.getElementById('toPage3').disabled = false;
          document.querySelectorAll('.garment-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
        });
        grid.appendChild(item);
      });
    }

    // Setup Camera
    function setupCamera() {
      const video = document.getElementById('video');
      const loading = document.getElementById('cameraLoading');
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          loading.style.display = 'none';
        })
        .catch(error => {
          console.error('Camera error:', error);
          loading.style.display = 'none';
          document.getElementById('alternativeUpload').style.display = 'block';
          document.getElementById('cameraError').textContent = 'Unable to access camera. Please upload an image instead.';
        });
    }

    // Start Countdown for Photo Capture
    function startCountdown() {
      let count = 3;
      const timer = document.getElementById('timer');
      timer.style.display = 'block';
      const interval = setInterval(() => {
        timer.textContent = count;
        count--;
        if (count < 0) {
          clearInterval(interval);
          timer.style.display = 'none';
          capturePhoto();
        }
      }, 1000);
    }

    // Capture Photo
    function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      canvas.toBlob(blob => {
        const formData = new FormData();
        formData.append('images', blob, 'user_photo.jpg');
        formData.append('folder', 'user_photos');
        formData.append('isUserPhoto', 'true');
        fetch('/upload', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(result => {
            if (result.images && result.images.length > 0) {
              userPhotoUrl = result.images[0].url;
              document.getElementById('toPage4').disabled = false;
            } else {
              throw new Error('Upload failed');
            }
          })
          .catch(error => {
            console.error('Upload error:', error);
            document.getElementById('cameraError').textContent = 'Failed to upload photo.';
          });
      }, 'image/jpeg');
    }

    // Poll for Results and Update Display
    function pollForResults() {
      if (!jobId) return;

      const interval = setInterval(() => {
        fetch(`/get-result/${jobId}`)
          .then(response => response.json())
          .then(data => {
            if (data.status === 'completed' && isFormSubmitted) {
              clearInterval(interval);
              const resultImage = document.getElementById('resultImage');
              if (resultImage) {
                resultImage.src = data.output;
                document.getElementById('resultContainer').style.display = 'block';
                document.getElementById('outputId').textContent = `Output ID: ${data.output_id || 'N/A'}`;
                // Hide progress bar when result is displayed
                const progressBar = document.getElementById('tryonProgressBar');
                if (progressBar) {
                  progressBar.style.display = 'none';
                } else {
                  console.error('tryonProgressBar element not found');
                }
              } else {
                console.error('resultImage element not found');
              }
            }
          })
          .catch(error => console.error('Error polling result:', error));
      }, 10000); // Poll every 10 seconds
    }

    // Initialize Stores
    fetchStores()
      .then(stores => {
        if (stores.length === 0) {
          document.getElementById('loading-stores').innerHTML = '<p>No stores available at this time.</p>';
        } else {
          displayStores(stores);
        }
      })
      .catch(error => {
        console.error('Error fetching stores:', error.message);
        document.getElementById('loading-stores').innerHTML = '<p>Unable to load stores: ' + error.message + '</p>';
      });

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Navigation Event Listeners
      const toPage2Btn = document.getElementById('toPage2');
      if (toPage2Btn) {
        toPage2Btn.addEventListener('click', () => {
          switchPage('page1', 'page2');
          document.getElementById('garmentSpinner').style.display = 'block';
          fetchGarmentsForStore(selectedStore.id)
            .then(garments => {
              if (garments.length === 0) {
                document.getElementById('garmentGrid').innerHTML = '<p>No garments available for this store.</p>';
                document.getElementById('garmentSpinner').style.display = 'none';
              } else {
                displayGarments(garments);
              }
            })
            .catch(error => {
              console.error('Error fetching garments:', error.message);
              document.getElementById('garmentError').textContent = 'Error loading garments: ' + error.message;
              document.getElementById('garmentSpinner').style.display = 'none';
            });
        });
      }

      const backToPage1Btn = document.getElementById('backToPage1');
      if (backToPage1Btn) {
        backToPage1Btn.addEventListener('click', () => switchPage('page2', 'page1'));
      }

      const toPage3Btn = document.getElementById('toPage3');
      if (toPage3Btn) {
        toPage3Btn.addEventListener('click', () => {
          switchPage('page2', 'page3');
          setupCamera();
        });
      }

      const backToPage2Btn = document.getElementById('backToPage2');
      if (backToPage2Btn) {
        backToPage2Btn.addEventListener('click', () => switchPage('page3', 'page2'));
      }

      const captureBtn = document.getElementById('captureBtn');
      if (captureBtn) {
        captureBtn.addEventListener('click', startCountdown);
      }

      const toPage4Btn = document.getElementById('toPage4');
      if (toPage4Btn) {
        toPage4Btn.addEventListener('click', () => {
          switchPage('page3', 'page4');
          document.getElementById('userPhoto').src = userPhotoUrl;
          document.getElementById('selectedGarment').src = selectedGarment.url;
          document.getElementById('garmentType').textContent = selectedGarment.type || 'N/A';
          document.getElementById('garmentColor').textContent = selectedGarment.color || 'N/A';
        });
      }

      const backToPage3Btn = document.getElementById('backToPage3');
      if (backToPage3Btn) {
        backToPage3Btn.addEventListener('click', () => switchPage('page4', 'page3'));
      }

      const startOverBtn = document.getElementById('startOver');
      if (startOverBtn) {
        startOverBtn.addEventListener('click', () => {
          selectedStore = null;
          selectedGarment = null;
          userPhotoUrl = null;
          jobId = null;
          orderId = null;
          isFormSubmitted = false;
          // Hide progress bar on start over
          const progressBar = document.getElementById('tryonProgressBar');
          if (progressBar) {
            progressBar.style.display = 'none';
          }
          document.getElementById('toPage2').disabled = true;
          document.getElementById('toPage3').disabled = true;
          document.getElementById('toPage4').disabled = true;
          switchPage('page4', 'page1');
          fetchStores()
            .then(stores => {
              if (stores.length === 0) {
                document.getElementById('loading-stores').innerHTML = '<p>No stores available at this time.</p>';
              } else {
                displayStores(stores);
              }
            })
            .catch(error => {
              console.error('Error fetching stores:', error.message);
              document.getElementById('loading-stores').innerHTML = '<p>Unable to load stores: ' + error.message + '</p>';
            });
        });
      }

      // Try On Button
      const tryOnBtn = document.getElementById('tryOnBtn');
      if (tryOnBtn) {
        tryOnBtn.addEventListener('click', () => {
          if (!userPhotoUrl || !selectedGarment) {
            alert('Please upload a photo and select a garment first.');
            return;
          }

          // Show progress bar
          const progressBar = document.getElementById('tryonProgressBar');
          if (progressBar) {
            progressBar.style.display = 'block';
          } else {
            console.error('tryonProgressBar element not found');
          }

          // Call Try-On API directly
          const payload = {
            human: userPhotoUrl,
            garment: selectedGarment.url,
            garment_description: `${selectedGarment.color || 'N/A'} ${selectedGarment.type || 'N/A'}`,
            category: 'upper_body',
            storeName: selectedStore ? selectedStore.store_name : null
          };

          console.log('Sending try-on request with payload:', payload);

          fetch('/tryon', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                jobId = data.job_id;
                console.log('Try-on job submitted, jobId:', jobId);
                pollForResults();
              } else {
                console.error('Try-on failed:', data.error, data.details);
                // Hide progress bar on error
                const progressBar = document.getElementById('tryonProgressBar');
                if (progressBar) {
                  progressBar.style.display = 'none';
                }
                let errorMessage = data.error || 'Unknown error';
                if (errorMessage.includes('Garment image URL is inaccessible')) {
                  errorMessage = 'The selected garment image is not available. Please try a different garment or contact support.';
                }
                alert(`Try-on request failed: ${errorMessage}. Please try again.`);
              }
            })
            .catch(error => {
              console.error('Error calling try-on API:', error);
              // Hide progress bar on error
              const progressBar = document.getElementById('tryonProgressBar');
              if (progressBar) {
                progressBar.style.display = 'none';
              }
              alert('Error submitting try-on request. Please try again.');
            });

          // Show the form for order details
          const overlay = document.querySelector('.overlay');
          const form = document.querySelector('.popup-form');
          if (overlay && form) {
            overlay.classList.add('show');
            form.classList.add('show');
            document.getElementById('formStoreDetail').textContent = selectedStore ? selectedStore.store_name : 'N/A';
            document.getElementById('formGarmentDetail').textContent = selectedGarment ? selectedGarment.name : 'N/A';
          } else {
            console.error('Overlay or form element not found');
          }
        });
      } else {
        console.error('tryOnBtn element not found');
      }

      // Close Form Button
      const closeFormBtn = document.getElementById('closeFormBtn');
      if (closeFormBtn) {
        closeFormBtn.addEventListener('click', () => {
          const form = document.querySelector('.popup-form');
          const overlay = document.querySelector('.overlay');
          if (form && overlay) {
            form.classList.remove('show');
            overlay.classList.remove('show');
          } else {
            console.error('Form or overlay element not found');
          }
        });
      } else {
        console.error('closeFormBtn element not found');
      }

      // Form Submission Handler
      const submitFormBtn = document.getElementById('submitFormBtn');
      if (submitFormBtn) {
        submitFormBtn.addEventListener('click', async () => {
          if (submitFormBtn.disabled) {
            console.log('Form submission already in progress');
            return;
          }

          submitFormBtn.disabled = true;
          const name = document.getElementById('userName').value.trim();
          const phone = document.getElementById('userPhone').value.trim();
          const requiredMessage = document.querySelector('.required-message');

          if (!name || !phone) {
            if (requiredMessage) {
              requiredMessage.classList.add('visible');
              document.querySelectorAll('.form-group input').forEach(input => {
                if (!input.value.trim()) input.classList.add('error');
                else input.classList.remove('error');
              });
            }
            submitFormBtn.disabled = false;
            return;
          }

          if (requiredMessage) {
            requiredMessage.classList.remove('visible');
            document.querySelectorAll('.form-group input').forEach(input => input.classList.remove('error'));
          }

          try {
            // Save order via server endpoint
            const orderResponse = await fetch('/save-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name,
                phone,
                garmentName: selectedGarment.name,
                storeName: selectedStore ? selectedStore.store_name : 'Unknown'
              })
            });

            const orderData = await orderResponse.json();
            if (!orderData.success) {
              throw new Error(orderData.error || 'Failed to save order');
            }

            // Store orderId from response
            orderId = orderData.orderId;
            console.log('Order saved with orderId:', orderId, 'Garment:', selectedGarment.name, 'Store:', selectedStore?.store_name);

            // Set isFormSubmitted to true to allow result display
            isFormSubmitted = true;
          } catch (error) {
            console.error('Error processing order:', error);
            alert('Error processing your request. Please try again.');
          } finally {
            submitFormBtn.disabled = false;
          }
        });
      } else {
        console.error('submitFormBtn element not found');
      }

      // Buy Now Button
      const buyBtn = document.getElementById('buyBtn');
      if (buyBtn) {
        buyBtn.addEventListener('click', async () => {
          if (!orderId) {
            console.error('No orderId found for Buy Now action');
            alert('No order found. Please complete the try-on process first.');
            return;
          }

          console.log('Buy Now clicked with orderId:', orderId, 'Garment:', selectedGarment?.name, 'Store:', selectedStore?.store_name);

          // Confirm with user
          const confirmPurchase = confirm(
            `Do you want to mark the order for "${selectedGarment?.name || 'Unknown Garment'}" from "${selectedStore?.store_name || 'Unknown Store'}" as wanted?`
          );
          if (!confirmPurchase) {
            console.log('User cancelled Buy Now action');
            return;
          }

          try {
            const response = await fetch('/update-order-wanted', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId })
            });

            const data = await response.json();
            if (data.success) {
              console.log(`Order ${orderId} marked as wanted`);
              alert('Order marked as wanted successfully!');
            } else {
              throw new Error(data.error || 'Failed to mark order as wanted');
            }
          } catch (error) {
            console.error('Error marking order as wanted:', error);
            alert(`Failed to mark order as wanted: ${error.message}. Please try again.`);
          }
        });
      } else {
        console.error('buyBtn element not found');
      }

      // Theme Toggle
      const themeToggleBtn = document.getElementById('themeToggle');
      if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
          document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
        });
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner {
      display: none;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #1e40af;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    .spinner.active {
      display: block;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .header-logo {
      display: block;
      margin: 0 auto 20px auto;
      max-height: 100px;
      width: auto;
    }
    .form-error {
      color: #ff4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    #error-message, #success-message {
      display: none;
    }
    .password-container {
      position: relative;
    }
    .password-toggle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #4b5563;
      font-size: 1rem;
      padding: 0;
    }
    .password-toggle:hover {
      color: #1e40af;
    }
    .password-toggle::before {
      content: 'üëÅÔ∏è';
    }
    .password-toggle.hidden::before {
      content: 'üôà';
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 50;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    
    /* Inline editing styles */
    tr.editing {
      background-color: #f0f9ff !important; /* Light blue background */
      box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
    }
    
    tr.editing td {
      position: relative;
    }
    
    tr.editing input, tr.editing select {
      border: 1px solid #60a5fa;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      width: 100%;
      background-color: white;
    }
    
    tr.editing input:focus, tr.editing select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }
    
    tr:not(.editing):hover {
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login Screen -->
  <div id="login-screen" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
      <img src="/MetaVrLogo.jpg" alt="MetaVR Logo" class="header-logo">
      <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
      <p id="error-message" class="text-red-500 mb-4"></p>
      <p id="success-message" class="text-green-500 mb-4"></p>
      <form id="login-form">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <input
            type="email"
            id="login-email"
            class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
            required
          >
        </div>
        <div class="mb-4 password-container">
          <label class="block text-sm font-medium text-gray-700">Password</label>
          <input
            type="password"
            id="login-password"
            class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500 pr-10"
            required
          >
          <button
            type="button"
            id="toggle-login-password"
            class="password-toggle"
            aria-label="Toggle password visibility"
          ></button>
        </div>
        <button
          type="submit"
          id="login-button"
          class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-blue-300"
        >
          Login
        </button>
      </form>
      <div id="login-spinner" class="spinner mt-4"></div>
    </div>
  </div>

  <!-- Dashboard Screen -->
  <div id="dashboard-screen" class="p-6 hidden">
    <div class="max-w-7xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <div>
          <img src="/MetaVrLogo.jpg" alt="MetaVR Logo" class="header-logo">
          <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
        </div>
        <button
          id="logout-button"
          class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700"
        >
          Logout
        </button>
      </div>

      <!-- Create Store Form -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4">Create New Store Account</h2>
        <p id="form-error" class="text-red-500 mb-4"></p>
        <p id="form-success" class="text-green-500 mb-4"></p>
        <form id="create-store-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Store Name *</label>
            <input
              type="text"
              id="store_name"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              required
            >
            <p id="store_name-error" class="form-error"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email *</label>
            <input
              type="email"
              id="email"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              required
            >
            <p id="email-error" class="form-error"></p>
          </div>
          <div class="password-container">
            <label class="block text-sm font-medium text-gray-700">Password *</label>
            <input
              type="password"
              id="password"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500 pr-10"
              required
            >
            <button
              type="button"
              id="toggle-password"
              class="password-toggle"
              aria-label="Toggle password visibility"
            ></button>
            <p id="password-error" class="form-error"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Specialization *</label>
            <input
              type="text"
              id="specialization"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              required
            >
            <p id="specialization-error" class="form-error"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Country</label>
            <input
              type="text"
              id="country"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Logo Link</label>
            <input
              type="url"
              id="logo_link"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
            >
            <p id="logo_link-error" class="form-error"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">User Name</label>
            <input
              type="text"
              id="user_name"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Access *</label>
            <input
              type="checkbox"
              id="access"
              class="mt-1 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              checked
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Garment Limit *</label>
            <input
              type="number"
              id="garment_limit"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              min="1"
              max="100"
              value="6"
              required
            >
            <p id="garment_limit-error" class="form-error"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">TryOn Limit *</label>
            <input
              type="number"
              id="tryon_limit"
              class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              min="0"
              max="1000"
              value="10"
              required
            >
            <p id="tryon_limit-error" class="form-error"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Store Logo</label>
            <div class="mt-1 flex items-center">
              <input
                type="file"
                id="logo"
                accept="image/*"
                class="p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <p class="text-xs text-gray-500 mt-1">Upload a logo image for the store. Will be displayed on the store selection page.</p>
            <p id="logo-error" class="form-error"></p>
          </div>
          <div class="md:col-span-2 flex items-center">
            <button
              type="submit"
              id="create-store-button"
              class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-blue-300"
            >
              Create Store
            </button>
            <div id="form-spinner" class="spinner ml-4"></div>
          </div>
        </form>
      </div>

      <!-- Edit Store Modal -->
      <div id="edit-store-modal" class="modal">
        <div class="modal-content">
          <h2>Edit Store Account</h2>
          <p id="edit-form-error" class="text-red-500 mb-4"></p>
          <p id="edit-form-success" class="text-green-500 mb-4"></p>
          <form id="edit-store-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" id="edit-store-id">
            <div>
              <label class="block text-sm font-medium text-gray-700">Store Name *</label>
              <input
                type="text"
                id="edit-store_name"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
                required
              >
              <p id="edit-store_name-error" class="form-error"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Email *</label>
              <input
                type="email"
                id="edit-email"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
                required
              >
              <p id="edit-email-error" class="form-error"></p>
            </div>
            <div class="password-container">
              <label class="block text-sm font-medium text-gray-700">Password</label>
              <input
                type="password"
                id="edit-password"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500 pr-10"
              >
              <button
                type="button"
                id="edit-toggle-password"
                class="password-toggle"
                aria-label="Toggle password visibility"
              ></button>
              <p id="edit-password-error" class="form-error"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Specialization *</label>
              <input
                type="text"
                id="edit-specialization"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
                required
              >
              <p id="edit-specialization-error" class="form-error"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Country</label>
              <input
                type="text"
                id="edit-country"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Logo Link</label>
              <input
                type="url"
                id="edit-logo_link"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              >
              <p id="edit-logo_link-error" class="form-error"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">User Name</label>
              <input
                type="text"
                id="edit-user_name"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Access *</label>
              <input
                type="checkbox"
                id="edit-access"
                class="mt-1 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              >
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Garment Limit *</label>
              <input
                type="number"
                id="edit-garment_limit"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
                min="1"
                max="100"
                required
              >
              <p id="edit-garment_limit-error" class="form-error"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">TryOn Limit *</label>
              <input
                type="number"
                id="edit-tryon_limit"
                class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-blue-500"
                min="0"
                max="1000"
                required
              >
              <p id="edit-tryon_limit-error" class="form-error"></p>
            </div>
            <div class="md:col-span-2 flex justify-end gap-4">
              <button
                type="button"
                id="cancel-edit-button"
                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="save-edit-button"
                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-blue-300"
              >
                Save Changes
              </button>
            </div>
          </form>
          <div id="edit-form-spinner" class="spinner mt-4"></div>
        </div>
      </div>

      <!-- Stores Table -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Existing Stores</h2>
        <div id="table-spinner" class="spinner active mb-4"></div>
        <p id="no-stores" class="text-gray-500 hidden">No stores found.</p>
        <div id="stores-table" class="overflow-x-auto hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Store Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Specialization</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Logo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Access</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Garment Limit</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TryOn Limit</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="stores-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000'
      : window.location.origin;

    const loginScreen = document.getElementById('login-screen');
    const dashboardScreen = document.getElementById('dashboard-screen');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const loginForm = document.getElementById('login-form');
    const loginButton = document.getElementById('login-button');
    const loginSpinner = document.getElementById('login-spinner');
    const logoutButton = document.getElementById('logout-button');
    const createStoreForm = document.getElementById('create-store-form');
    const createStoreButton = document.getElementById('create-store-button');
    const formSpinner = document.getElementById('form-spinner');
    const formError = document.getElementById('form-error');
    const formSuccess = document.getElementById('form-success');
    const tableSpinner = document.getElementById('table-spinner');
    const noStores = document.getElementById('no-stores');
    const storesTable = document.getElementById('stores-table');
    const storesTableBody = document.getElementById('stores-table-body');
    const loginPasswordInput = document.getElementById('login-password');
    const toggleLoginPassword = document.getElementById('toggle-login-password');
    const passwordInput = document.getElementById('password');
    const togglePassword = document.getElementById('toggle-password');
    const editStoreModal = document.getElementById('edit-store-modal');
    const editStoreForm = document.getElementById('edit-store-form');
    const editFormError = document.getElementById('edit-form-error');
    const editFormSuccess = document.getElementById('edit-form-success');
    const editFormSpinner = document.getElementById('edit-form-spinner');
    const saveEditButton = document.getElementById('save-edit-button');
    const cancelEditButton = document.getElementById('cancel-edit-button');
    const editPasswordInput = document.getElementById('edit-password');
    const editTogglePassword = document.getElementById('edit-toggle-password');

    let token = localStorage.getItem('adminToken') || '';
    let currentlyEditing = null;

    // Show/hide elements
    function showElement(element) {
      element.classList.remove('hidden');
      element.style.display = '';
    }
    function hideElement(element) {
      element.classList.add('hidden');
      element.style.display = 'none';
    }

    // Show error/success messages
    function showError(element, message) {
      element.textContent = message;
      showElement(element);
    }
    function showSuccess(element, message) {
      element.textContent = message;
      showElement(element);
    }
    function clearMessages() {
      hideElement(errorMessage);
      hideElement(successMessage);
      hideElement(formError);
      hideElement(formSuccess);
      hideElement(editFormError);
      hideElement(editFormSuccess);
      errorMessage.textContent = '';
      successMessage.textContent = '';
      formError.textContent = '';
      formSuccess.textContent = '';
      editFormError.textContent = '';
      editFormSuccess.textContent = '';
    }

    // Validate form inputs
    function validateForm(formId = 'create-store-form') {
      const errors = {};
      const prefix = formId === 'edit-store-form' ? 'edit-' : '';
      const storeName = document.getElementById(`${prefix}store_name`).value.trim();
      const email = document.getElementById(`${prefix}email`).value.trim();
      const password = document.getElementById(`${prefix}password`).value;
      const specialization = document.getElementById(`${prefix}specialization`).value.trim();
      const logoLink = document.getElementById(`${prefix}logo_link`).value.trim();
      const garmentLimit = document.getElementById(`${prefix}garment_limit`).value;
      const tryonLimit = document.getElementById(`${prefix}tryon_limit`).value;

      if (!storeName) errors.store_name = 'Store name is required';
      if (!email) errors.email = 'Email is required';
      else if (!/\S+@\S+\.\S+/.test(email)) errors.email = 'Invalid email format';
      if (formId === 'create-store-form' && !password) errors.password = 'Password is required';
      if (formId === 'create-store-form' && password && password.length < 6) errors.password = 'Password must be at least 6 characters';
      if (formId === 'edit-store-form' && password && password.length < 6) errors.password = 'Password must be at least 6 characters';
      if (!specialization) errors.specialization = 'Specialization is required';
      if (logoLink && !/^https?:\/\/[^\s$.?#].[^\s]*$/.test(logoLink)) {
        errors.logo_link = 'Invalid URL format';
      }
      if (!garmentLimit) errors.garment_limit = 'Garment limit is required';
      else if (isNaN(garmentLimit) || parseInt(garmentLimit) < 1) errors.garment_limit = 'Garment limit must be at least 1';
      if (!tryonLimit) errors.tryon_limit = 'TryOn limit is required';
      else if (isNaN(tryonLimit) || parseInt(tryonLimit) < 0) errors.tryon_limit = 'TryOn limit must be at least 0';

      // Clear previous errors
      document.querySelectorAll(`#${formId} .form-error`).forEach(el => el.textContent = '');
      // Display new errors
      Object.keys(errors).forEach(key => {
        document.getElementById(`${prefix}${key}-error`).textContent = errors[key];
      });

      return Object.keys(errors).length === 0;
    }

    // Fetch stores
    async function fetchStores() {
      showElement(tableSpinner);
      hideElement(noStores);
      hideElement(storesTable);
      storesTableBody.innerHTML = '';

      try {
        const response = await fetch(`${API_URL}/stores`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` },
          credentials: 'include'
        });
        
        const result = await response.json();
        if (response.ok) {
          const stores = result.stores || [];
          if (stores.length === 0) {
            showElement(noStores);
          } else {
            stores.forEach(store => {
              const row = document.createElement('tr');
              row.dataset.storeId = store.store_name;
              const maskedPassword = store.plain_password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '-';
              
              // Create each cell with a data attribute for the field name
              row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap" data-field="store_name">${sanitize(store.store_name)}</td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="email">${sanitize(store.email)}</td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="password">
                  <span class="password-display">${maskedPassword}</span>
                  ${store.plain_password ? `<button class="password-toggle-btn ml-2 text-gray-500 hover:text-blue-700" data-password="${sanitize(store.plain_password)}">üëÅÔ∏è</button>` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="specialization">${sanitize(store.specialization)}</td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="country">${store.country ? sanitize(store.country) : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="user_name">${store.user_name ? sanitize(store.user_name) : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="logo_link">
                  ${store.logo_link ? `<img src="${sanitize(store.logo_link)}" alt="Logo" class="h-10 w-10 object-contain" onerror="this.src='/MetaVrLogo.jpg'">` : '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="access">
                  <span class="access-value">${store.access ? 'Yes' : 'No'}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="garment_limit">${store.garment_limit ? sanitize(store.garment_limit) : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="tryon_limit">${store.tryon_limit ? sanitize(store.tryon_limit) : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap" data-field="actions">
                  <button class="edit-store-btn text-blue-600 hover:text-blue-800 mr-2" data-store-id="${sanitize(store.store_name)}">Edit</button>
                  <button class="save-store-btn text-green-600 hover:text-green-800 mr-2 hidden" data-store-id="${sanitize(store.store_name)}">Save</button>
                  <button class="cancel-store-btn text-gray-600 hover:text-gray-800 mr-2 hidden" data-store-id="${sanitize(store.store_name)}">Cancel</button>
                  <button class="delete-store-btn text-red-600 hover:text-red-800" data-store-id="${sanitize(store.store_name)}">Delete</button>
                </td>
              `;
              storesTableBody.appendChild(row);
            });
            
            // Add event listeners for password toggle
            document.querySelectorAll('.password-toggle-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                const display = btn.previousElementSibling;
                const isHidden = display.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                display.textContent = isHidden ? btn.dataset.password : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                btn.textContent = isHidden ? 'üôà' : 'üëÅÔ∏è';
                logClientAction('toggle_store_password_visibility', { store_name: btn.closest('tr').dataset.storeId, visible: isHidden });
              });
            });
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-store-btn').forEach(btn => {
              btn.addEventListener('click', () => toggleInlineEdit(btn.dataset.storeId));
            });
            
            document.querySelectorAll('.save-store-btn').forEach(btn => {
              btn.addEventListener('click', () => saveInlineEdit(btn.dataset.storeId));
            });
            
            document.querySelectorAll('.cancel-store-btn').forEach(btn => {
              btn.addEventListener('click', () => cancelInlineEdit(btn.dataset.storeId));
            });
            
            document.querySelectorAll('.delete-store-btn').forEach(btn => {
              btn.addEventListener('click', () => deleteStore(btn.dataset.storeId));
            });
            
            showElement(storesTable);
          }
        } else {
          throw new Error(result.error || 'Failed to fetch stores');
        }
      } catch (err) {
        showError(formError, `Failed to fetch stores: ${err.message}`);
        token = '';
        localStorage.removeItem('adminToken');
        showElement(loginScreen);
        hideElement(dashboardScreen);
      } finally {
        hideElement(tableSpinner);
      }
    }

    // Sanitize input to prevent XSS
    function sanitize(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    // Log client actions
    function logClientAction(action, details = {}) {
      const log = {
        page: 'admin',
        level: action.includes('error') ? 'error' : 'info',
        action,
        details,
        timestamp: new Date().toISOString()
      };
      console.log(`[${log.timestamp}] [${log.level.toUpperCase()}] ${log.action}`, log.details);
      fetch(`${API_URL}/client-logs`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ logs: [log] })
      }).catch(err => console.error('Failed to send client log:', err));
    }

    // Password visibility toggle
    function setupPasswordToggle(input, toggleButton) {
      toggleButton.addEventListener('click', () => {
        const isHidden = input.type === 'password';
        input.type = isHidden ? 'text' : 'password';
        toggleButton.classList.toggle('hidden', !isHidden);
        logClientAction('toggle_password_visibility', { input: input.id, visible: isHidden });
      });
    }

    // Initialize password toggles
    setupPasswordToggle(loginPasswordInput, toggleLoginPassword);
    setupPasswordToggle(passwordInput, togglePassword);
    setupPasswordToggle(editPasswordInput, editTogglePassword);

    // Open edit modal
    async function openEditModal(storeId) {
      clearMessages();
      showElement(editStoreModal);
      logClientAction('open_edit_store_modal', { store_name: storeId });

      try {
        const response = await fetch(`${API_URL}/stores`, {
          method: 'GET',
          headers: { 
            'Authorization': `Bearer ${token}` 
          },
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error(`Failed to fetch stores: ${response.status}`);
        }
        
        const result = await response.json();
        const store = result.stores.find(s => s.store_name === storeId);
        
        if (store) {
          document.getElementById('edit-store-id').value = store.store_name;
          document.getElementById('edit-store_name').value = store.store_name;
          document.getElementById('edit-email').value = store.email;
          document.getElementById('edit-specialization').value = store.specialization;
          document.getElementById('edit-country').value = store.country || '';
          document.getElementById('edit-user_name').value = store.user_name || '';
          document.getElementById('edit-logo_link').value = store.logo_link || '';
          document.getElementById('edit-garment_limit').value = store.garment_limit || '6';
          document.getElementById('edit-tryon_limit').value = store.tryon_limit || '10';
          
          const accessCheckbox = document.getElementById('edit-access');
          if (accessCheckbox) {
            accessCheckbox.checked = store.access === true;
          }
        } else {
          throw new Error('Store not found');
        }
      } catch (error) {
        console.error('Error opening edit modal:', error);
        showError(editFormError, `Error: ${error.message}`);
      }
    }

    // Delete store
    async function deleteStore(storeId) {
      if (!confirm('Are you sure you want to delete this store account?')) {
        return;
      }
      clearMessages();
      logClientAction('delete_store_attempt', { store_name: storeId });

      try {
        const response = await fetch(`${API_URL}/stores/${storeId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` },
          credentials: 'include'
        });
        
        const result = await response.json();
        if (response.ok) {
          showSuccess(formSuccess, 'Store account deleted successfully');
          logClientAction('delete_store_success', { store_name: storeId });
          fetchStores();
        } else {
          throw new Error(result.error || 'Failed to delete store');
        }
      } catch (err) {
        showError(formError, `Error deleting store account: ${err.message}`);
        logClientAction('delete_store_error', { message: err.message, store_name: storeId });
      }
    }

    // Handle login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();
      loginButton.disabled = true;
      showElement(loginSpinner);
      logClientAction('login_attempt', { email: document.getElementById('login-email').value });

      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        showError(errorMessage, 'Please enter both email and password');
        logClientAction('login_error', { message: 'Missing email or password' });
        loginButton.disabled = false;
        hideElement(loginSpinner);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password })
        });
        
        const result = await response.json();
        if (response.ok) {
          token = result.token;
          localStorage.setItem('adminToken', token);
          logClientAction('login_success', { email });
          hideElement(loginScreen);
          showElement(dashboardScreen);
          loginForm.reset();
          fetchStores();
        } else {
          throw new Error(result.error || 'Invalid credentials');
        }
      } catch (err) {
        console.error('Login error:', err);
        showError(errorMessage, `Login failed: ${err.message}`);
        logClientAction('login_error', { message: err.message });
      } finally {
        loginButton.disabled = false;
        hideElement(loginSpinner);
      }
    });

    // Handle logout
    logoutButton.addEventListener('click', () => {
      logClientAction('logout');
      token = '';
      localStorage.removeItem('adminToken');
      hideElement(dashboardScreen);
      showElement(loginScreen);
      showSuccess(successMessage, 'Logged out successfully');
      createStoreForm.reset();
      storesTableBody.innerHTML = '';
      hideElement(storesTable);
      hideElement(noStores);
    });

    // Handle create store
    createStoreForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();
      createStoreButton.disabled = true;
      showElement(formSpinner);
      logClientAction('create_store_attempt');

      if (!validateForm()) {
        showError(formError, 'Please correct the errors in the form');
        logClientAction('create_store_error', { message: 'Form validation failed' });
        createStoreButton.disabled = false;
        hideElement(formSpinner);
        return;
      }

      const formData = {
        store_name: document.getElementById('store_name').value.trim(),
        email: document.getElementById('email').value.trim(),
        password: document.getElementById('password').value,
        specialization: document.getElementById('specialization').value.trim(),
        country: document.getElementById('country').value.trim(),
        logo_link: document.getElementById('logo_link').value.trim(),
        user_name: document.getElementById('user_name').value.trim(),
        access: document.getElementById('access').checked,
        garment_limit: document.getElementById('garment_limit').value,
        tryon_limit: document.getElementById('tryon_limit').value
      };

      try {
        // Upload the logo first if one is selected
        const logoFile = document.getElementById('logo').files[0];
        if (logoFile) {
          const logoFormData = new FormData();
          logoFormData.append('logo', logoFile);
          
          // Create the store first to get the storeId
          const storeResponse = await fetch(`${API_URL}/stores`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            credentials: 'include',
            body: JSON.stringify(formData)
          });
          
          if (!storeResponse.ok) {
            throw new Error('Failed to create store account');
          }
          
          const storeResult = await storeResponse.json();
          
          // Then upload the logo using store_name instead of ID
          logoFormData.append('storeName', formData.store_name);
          
          const logoResponse = await fetch(`${API_URL}/store/upload-logo`, {
            method: 'POST',
            credentials: 'include',
            body: logoFormData
          });
          
          if (!logoResponse.ok) {
            console.warn('Logo upload failed, but store was created');
          }
          
          showSuccess(formSuccess, 'Store account created successfully with logo');
        } else {
          // Just create the store without a logo
          const response = await fetch(`${API_URL}/stores`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            credentials: 'include',
            body: JSON.stringify(formData)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to create store account');
          }
          
          showSuccess(formSuccess, 'Store account created successfully');
        }
        
        createStoreForm.reset();
        document.getElementById('access').checked = true;
        fetchStores();
      } catch (error) {
        console.error('Error creating store:', error);
        showError(formError, error.message);
      } finally {
        createStoreButton.disabled = false;
        hideElement(formSpinner);
      }
    });

    // Handle edit store
    editStoreForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();
      saveEditButton.disabled = true;
      showElement(editFormSpinner);
      logClientAction('edit_store_attempt', { store_name: document.getElementById('edit-store_name').value.trim() });

      if (!validateForm('edit-store-form')) {
        showError(editFormError, 'Please correct the errors in the form');
        logClientAction('edit_store_error', { message: 'Form validation failed' });
        saveEditButton.disabled = false;
        hideElement(editFormSpinner);
        return;
      }

      const formData = {
        store_name: document.getElementById('edit-store_name').value.trim(),
        email: document.getElementById('edit-email').value.trim(),
        password: document.getElementById('edit-password').value || undefined,
        specialization: document.getElementById('edit-specialization').value.trim(),
        country: document.getElementById('edit-country').value.trim(),
        logo_link: document.getElementById('edit-logo_link').value.trim(),
        user_name: document.getElementById('edit-user_name').value.trim(),
        access: document.getElementById('edit-access').checked,
        garment_limit: document.getElementById('edit-garment_limit').value,
        tryon_limit: document.getElementById('edit-tryon_limit').value
      };

      try {
        const storeName = document.getElementById('edit-store_name').value.trim();
        const response = await fetch(`${API_URL}/stores/${storeName}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          credentials: 'include',
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        if (response.ok) {
          showSuccess(formSuccess, 'Store account updated successfully');
          showSuccess(editFormSuccess, 'Store account updated successfully');
          logClientAction('edit_store_success', { store_name: storeName });
          hideElement(editStoreModal);
          fetchStores();
        } else {
          throw new Error(result.error || 'Failed to update store');
        }
      } catch (err) {
        showError(editFormError, `Error updating store account: ${err.message}`);
        logClientAction('edit_store_error', { message: err.message, store_name: document.getElementById('edit-store_name').value.trim() });
      } finally {
        saveEditButton.disabled = false;
        hideElement(editFormSpinner);
      }
    });

    // Cancel edit
    cancelEditButton.addEventListener('click', () => {
      hideElement(editStoreModal);
      editStoreForm.reset();
      clearMessages();
      logClientAction('cancel_edit_store');
    });

    // Toggle inline editing for a store row
    function toggleInlineEdit(storeId) {
      // If there's already a row being edited, cancel that edit first
      if (currentlyEditing && currentlyEditing !== storeId) {
        cancelInlineEdit(currentlyEditing);
      }
      
      currentlyEditing = storeId;
      const row = document.querySelector(`tr[data-store-id="${storeId}"]`);
      const storeName = row.querySelector('td[data-field="store_name"]').textContent.trim();
      logClientAction('toggle_inline_edit', { store_name: storeName });
      
      // Add editing class for styling
      row.classList.add('editing');
      
      // Hide edit button, show save and cancel buttons
      const editBtn = row.querySelector('.edit-store-btn');
      const saveBtn = row.querySelector('.save-store-btn');
      const cancelBtn = row.querySelector('.cancel-store-btn');
      
      editBtn.classList.add('hidden');
      saveBtn.classList.remove('hidden');
      cancelBtn.classList.remove('hidden');
      
      // Make cells editable
      row.querySelectorAll('td[data-field]').forEach(cell => {
        const fieldName = cell.getAttribute('data-field');
        
        // Skip actions cell and password cell
        if (fieldName === 'actions' || fieldName === 'password') {
          return;
        }
        
        // Store original content for cancel operation
        cell.setAttribute('data-original', cell.innerHTML);
        
        if (fieldName === 'logo_link') {
          const img = cell.querySelector('img');
          const logoUrl = img ? img.getAttribute('src') : '';
          cell.innerHTML = `<input type="text" class="p-1 border rounded w-full" value="${logoUrl === '/MetaVrLogo.jpg' ? '' : logoUrl}" placeholder="Logo URL">`;
        } 
        else if (fieldName === 'access') {
          const isChecked = cell.textContent.trim() === 'Yes';
          cell.innerHTML = `
            <select class="p-1 border rounded w-full">
              <option value="true" ${isChecked ? 'selected' : ''}>Yes</option>
              <option value="false" ${!isChecked ? 'selected' : ''}>No</option>
            </select>
          `;
        }
        else if (fieldName === 'garment_limit' || fieldName === 'tryon_limit') {
          const value = cell.textContent.trim() === '-' ? (fieldName === 'garment_limit' ? '6' : '10') : cell.textContent.trim();
          cell.innerHTML = `<input type="number" class="p-1 border rounded w-full" value="${value}" min="${fieldName === 'garment_limit' ? '1' : '0'}" max="${fieldName === 'garment_limit' ? '100' : '1000'}">`;
        }
        else {
          // For text fields, create an input
          const value = cell.textContent.trim() === '-' ? '' : cell.textContent.trim();
          cell.innerHTML = `<input type="text" class="p-1 border rounded w-full" value="${value}">`;
        }
        
        // Add event listeners for keyboard navigation
        const input = cell.querySelector('input, select');
        if (input) {
          input.addEventListener('keydown', (e) => {
            // Enter key - save changes
            if (e.key === 'Enter') {
              e.preventDefault();
              saveInlineEdit(storeId);
            }
            // Escape key - cancel changes
            else if (e.key === 'Escape') {
              e.preventDefault();
              cancelInlineEdit(storeId);
            }
          });
        }
      });
      
      // Focus on first field
      const firstInput = row.querySelector('input');
      if (firstInput) {
        firstInput.focus();
      }
      
      // Add a document-level event listener for Escape key
      document.addEventListener('keydown', escapeEditHandler);
    }

    // Event handler for Escape key
    function escapeEditHandler(e) {
      if (e.key === 'Escape' && currentlyEditing) {
        cancelInlineEdit(currentlyEditing);
      }
    }

    // Cancel inline edits
    function cancelInlineEdit(storeId) {
      const row = document.querySelector(`tr[data-store-id="${storeId}"]`);
      logClientAction('cancel_inline_edit', { store_name: storeId });
      
      // Remove editing class
      row.classList.remove('editing');
      
      // Restore original cell contents
      row.querySelectorAll('td[data-field]').forEach(cell => {
        if (cell.hasAttribute('data-original')) {
          cell.innerHTML = cell.getAttribute('data-original');
          cell.removeAttribute('data-original');
        }
      });
      
      // Restore buttons
      const editBtn = row.querySelector('.edit-store-btn');
      const saveBtn = row.querySelector('.save-store-btn');
      const cancelBtn = row.querySelector('.cancel-store-btn');
      
      editBtn.classList.remove('hidden');
      saveBtn.classList.add('hidden');
      cancelBtn.classList.add('hidden');
      
      // Remove document-level event listener
      document.removeEventListener('keydown', escapeEditHandler);
      
      currentlyEditing = null;
    }

    // Save inline edits
    async function saveInlineEdit(storeId) {
      const row = document.querySelector(`tr[data-store-id="${storeId}"]`);
      const storeName = row.querySelector('td[data-field="store_name"] input') ? 
                       row.querySelector('td[data-field="store_name"] input').value.trim() : 
                       row.querySelector('td[data-field="store_name"]').textContent.trim();
                       
      logClientAction('save_inline_edit', { store_name: storeName });
      
      // Collect data from inputs
      const formData = {};
      
      row.querySelectorAll('td[data-field]').forEach(cell => {
        const fieldName = cell.getAttribute('data-field');
        
        // Skip actions and password cell
        if (fieldName === 'actions' || fieldName === 'password') {
          return;
        }
        
        if (fieldName === 'access') {
          const select = cell.querySelector('select');
          formData[fieldName] = select.value === 'true';
        } 
        else if (fieldName === 'logo_link') {
          const input = cell.querySelector('input');
          if (input && input.value.trim()) {
            formData[fieldName] = input.value.trim();
          }
        }
        else if (cell.querySelector('input')) {
          const value = cell.querySelector('input').value.trim();
          if (value) {
            formData[fieldName] = value;
          }
        }
      });
      
      // Show saving indicator
      const saveBtn = row.querySelector('.save-store-btn');
      saveBtn.textContent = 'Saving...';
      saveBtn.disabled = true;
      
      try {
        const response = await fetch(`${API_URL}/stores/${storeName}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          credentials: 'include',
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showSuccess(formSuccess, 'Store account updated successfully');
          logClientAction('inline_edit_success', { store_name: storeName });
          
          // Refresh the table to show updated data
          fetchStores();
        } else {
          throw new Error(result.error || 'Failed to update store');
        }
      } catch (err) {
        showError(formError, `Error updating store account: ${err.message}`);
        logClientAction('inline_edit_error', { message: err.message, store_name: storeName });
        
        // Enable save button again
        saveBtn.textContent = 'Save';
        saveBtn.disabled = false;
      } finally {
        currentlyEditing = null;
      }
    }

    // Check if already logged in
    if (token) {
      logClientAction('page_loaded');
      hideElement(loginScreen);
      showElement(dashboardScreen);
      fetchStores();
    } else {
      logClientAction('page_loaded');
    }
  </script>
</body>
</html>